{"changed":true,"filter":false,"title":"menus_controller.rb","tooltip":"/app/controllers/menus_controller.rb","value":"class MenusController < ApplicationController\n  before_action :set_menu,:set_week , only: [:show, :edit, :update, :destroy]\n\n  # GET /menus\n  # GET /menus.json\n  def index\n    @menus = Menu.all\n  end\n\n  # GET /menus/1\n  # GET /menus/1.json\n  def show\n  end\n\n  # GET /menus/new\n  def new\n    @menu = Menu.new\n  end\n\n  # GET /menus/1/edit\n  def edit\n  end\n  \n  def menuweek\n    @teste = \"teste\"\n  end\n  \n  def updatemenuweek\n    #cria uma hash (@menuweek_hash) com todos os menus da semana a partir da tabela\n    data = params[:id]\n    data_inicio = data.to_date\n    data_fim = data_inicio + 7.days\n    @menuweek=Menu.where(\"day >= ? AND day <= ?\", data_inicio, data_fim).take(49)\n    @menuweek_hash= Hash[@menuweek.map {|menu| [[menu.day,menu.meal], menu.recipe_id]}]\n    @teste=@menuweek\n    set_week\n  end\n\n  def showmenuweek\n    #cria uma hash (@menuweek_hash) com todos os menus da semana a partir da tabela\n    @teste = \"teste\"\n    set_menu\n    set_week\n    @menuweek=Menu.where(\"day > ? AND day < ?\", data_inicio, data_fim).take(49)\n    @menuweek_hash= Hash[@menuweek.map {|menu| [[menu.day,menu.meal], menu.recipe_id]}]\n  end\n  \n  def menuweekpost\n    #percorre as celulas do menu e actualiza a tabela\n    data_param = params[:id]\n    data = data_param.to_date\n    i=0\n    j=0\n    while i<= 6 do\n      while j<= 6 do\n        menu_form=params[\"optionrecipe_\" + j.to_s  + \"_\" + i.to_s]\n        @menu_table = Menu.where(day: data,meal: j.to_s ).first\n        if @menu_table \n          @menu_table.recipe_id = menu_form\n          @menu_table.save \n        else\n          if menu_form != \"\" then \n            @menu_table=Menu.new\n            @menu_table.day = data\n            @menu_table.meal= j.to_s\n            @menu_table.weekday=i.to_s\n            @menu_table.recipe_id = menu_form\n            @menu_table.save\n          end\n        end\n        j=j+1\n      end\n      j=0  \n      i=i+1 \n      data= data + 1.days\n    end\n    actualiza_nutrients_week\n    respond_to do |format|\n      format.html { redirect_to menus_url }\n      format.json { head :no_content }\n    end\n  end\n  \n  # POST /menus\n  # POST /menus.json\n  def create\n    @menu = Menu.new(menu_params)\n    respond_to do |format|\n      format.html { redirect_to @menu, notice: 'Menu was successfully created.' }\n      format.json { render action: 'show', status: :created, location: @menu }\n    end\n  end\n\n  # PATCH/PUT /menus/1\n  # PATCH/PUT /menus/1.json\n  def update\n    respond_to do |format|\n      if @menu.update(menu_params)\n        format.html { redirect_to @menu, notice: 'Menu was successfully updated.' }\n        format.json { head :no_content }\n      else\n        format.html { render action: 'edit' }\n        format.json { render json: @menu.errors, status: :unprocessable_entity }\n      end\n    end\n  end\n\n  # DELETE /menus/1\n  # DELETE /menus/1.json\n  def destroy\n    @menu.destroy\n    respond_to do |format|\n      format.html { redirect_to menus_url }\n      format.json { head :no_content }\n    end\n  end\n  \n  def actualiza_nutrients_week\n    #apaga todos os registo referente a esta semana na tabela dos nutrientes da semana\n    WeekNutrients.where(week_id: params[:id]).find_each do |week_nutrients|\n        week_nutrients.destroy\n    end\n    #vai buscar todos os nutrientes para cada uma das receitas e soma\n    set_menu_week\n    h=Hash.new(0)\n    @menuweek.each do |menu|\n      recipe = Recipe.find(menu.recipe_id)\n      recipe.recipe_nutrients.each do |recipe_nutrient|\n        #para cada ingrediente vai buscar os nutrientes\n        #Se o nutriente já existe na array, acrescenta, se não cria\n          if h.has_key?(recipe_nutrient.nutrient_id) then\n            h[recipe_nutrient.nutrient_id] = h[recipe_nutrient.nutrient_id]+recipe_nutrient.valor\n            #cria registo\n          else\n            h[recipe_nutrient.nutrient_id] = h[recipe_nutrient.nutrient_id]+recipe_nutrient.valor\n          end\n      end\n    end\n  #insere os nutrientes da semana na tabela\n  \n  h.each do |nutrient_id, amout_nutrient|\n    rec_nut=WeekNutrients.new\n    rec_nut.week_id = params[:id]\n    rec_nut.nutrient_id=nutrient_id\n    rec_nut.valor=amout_nutrient \n    rec_nut.save\n  end\n\n  end\n    \n  private\n    # Use callbacks to share common setup or constraints between actions.\n    def set_menu\n      @menu = Menu.find(params[:id])\n      byebug\n    end\n    \n    def set_week\n      @week = Week.find_by( first_day: params[:id])\n      byebug\n    end\n    \n    def set_menu_week\n      data = params[:id]\n      data_inicio = data.to_date\n      data_fim = data_inicio + 7.days\n      @menuweek=Menu.where(\"day > ? AND day < ?\", data_inicio, data_fim).take(49)\n      set_week\n    end\n\n    # Never trust parameters from the scary internet, only allow the white list through.\n    def menu_params\n      params.require(:menu).permit(:day, :weekday, :meal, :recipe_id, :id, :menu, :teste,\n              week_nutrients_attributes: [:id,:recipe_id,:nutrient_id,:valor])\n\n    end\n    \n    #def menu_params_week\n    #  params.require(:teste)\n    #end\nend\n","undoManager":{"mark":93,"position":100,"stack":[[{"start":{"row":1,"column":32},"end":{"row":1,"column":33},"action":"insert","lines":["e"],"id":1970}],[{"start":{"row":1,"column":33},"end":{"row":1,"column":34},"action":"insert","lines":["e"],"id":1971}],[{"start":{"row":1,"column":34},"end":{"row":1,"column":35},"action":"insert","lines":["k"],"id":1972}],[{"start":{"row":1,"column":25},"end":{"row":1,"column":26},"action":"insert","lines":[" "],"id":1973}],[{"start":{"row":1,"column":26},"end":{"row":1,"column":27},"action":"remove","lines":[","],"id":1974}],[{"start":{"row":1,"column":26},"end":{"row":2,"column":0},"action":"insert","lines":["",""],"id":1975},{"start":{"row":2,"column":0},"end":{"row":2,"column":2},"action":"insert","lines":["  "]}],[{"start":{"row":2,"column":0},"end":{"row":2,"column":2},"action":"remove","lines":["  "],"id":1976}],[{"start":{"row":1,"column":26},"end":{"row":2,"column":0},"action":"remove","lines":["",""],"id":1977}],[{"start":{"row":1,"column":26},"end":{"row":1,"column":35},"action":"remove","lines":[":set_week"],"id":1978}],[{"start":{"row":1,"column":26},"end":{"row":1,"column":27},"action":"remove","lines":[" "],"id":1979}],[{"start":{"row":1,"column":65},"end":{"row":1,"column":66},"action":"insert","lines":[" "],"id":1980}],[{"start":{"row":1,"column":66},"end":{"row":1,"column":75},"action":"insert","lines":[":set_week"],"id":1981}],[{"start":{"row":1,"column":74},"end":{"row":1,"column":75},"action":"remove","lines":["k"],"id":1982}],[{"start":{"row":1,"column":73},"end":{"row":1,"column":74},"action":"remove","lines":["e"],"id":1983}],[{"start":{"row":1,"column":72},"end":{"row":1,"column":73},"action":"remove","lines":["e"],"id":1984}],[{"start":{"row":1,"column":71},"end":{"row":1,"column":72},"action":"remove","lines":["w"],"id":1985}],[{"start":{"row":1,"column":70},"end":{"row":1,"column":71},"action":"remove","lines":["_"],"id":1986}],[{"start":{"row":1,"column":69},"end":{"row":1,"column":70},"action":"remove","lines":["t"],"id":1987}],[{"start":{"row":1,"column":68},"end":{"row":1,"column":69},"action":"remove","lines":["e"],"id":1988}],[{"start":{"row":1,"column":67},"end":{"row":1,"column":68},"action":"remove","lines":["s"],"id":1989}],[{"start":{"row":1,"column":66},"end":{"row":1,"column":67},"action":"remove","lines":[":"],"id":1990}],[{"start":{"row":1,"column":65},"end":{"row":1,"column":66},"action":"remove","lines":[" "],"id":1991}],[{"start":{"row":1,"column":25},"end":{"row":1,"column":26},"action":"insert","lines":[","],"id":1992}],[{"start":{"row":1,"column":26},"end":{"row":1,"column":27},"action":"insert","lines":[","],"id":1993}],[{"start":{"row":1,"column":26},"end":{"row":1,"column":27},"action":"insert","lines":[":"],"id":1994}],[{"start":{"row":1,"column":27},"end":{"row":1,"column":28},"action":"insert","lines":["s"],"id":1995}],[{"start":{"row":1,"column":28},"end":{"row":1,"column":29},"action":"insert","lines":["e"],"id":1996}],[{"start":{"row":1,"column":29},"end":{"row":1,"column":30},"action":"insert","lines":["r"],"id":1997}],[{"start":{"row":1,"column":29},"end":{"row":1,"column":30},"action":"remove","lines":["r"],"id":1998}],[{"start":{"row":1,"column":29},"end":{"row":1,"column":30},"action":"insert","lines":["t"],"id":1999}],[{"start":{"row":1,"column":30},"end":{"row":1,"column":31},"action":"insert","lines":["_"],"id":2000}],[{"start":{"row":1,"column":31},"end":{"row":1,"column":32},"action":"insert","lines":["w"],"id":2001}],[{"start":{"row":1,"column":32},"end":{"row":1,"column":33},"action":"insert","lines":["e"],"id":2002}],[{"start":{"row":1,"column":33},"end":{"row":1,"column":34},"action":"insert","lines":["e"],"id":2003}],[{"start":{"row":1,"column":34},"end":{"row":1,"column":35},"action":"insert","lines":["k"],"id":2004}],[{"start":{"row":1,"column":35},"end":{"row":1,"column":36},"action":"insert","lines":[" "],"id":2005}],[{"start":{"row":157,"column":36},"end":{"row":158,"column":0},"action":"insert","lines":["",""],"id":2006},{"start":{"row":158,"column":0},"end":{"row":158,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":158,"column":6},"end":{"row":158,"column":50},"action":"insert","lines":["Person.find_by(name: 'Spartacus', rating: 4)"],"id":2007}],[{"start":{"row":157,"column":23},"end":{"row":157,"column":24},"action":"insert","lines":["_"],"id":2008}],[{"start":{"row":157,"column":24},"end":{"row":157,"column":25},"action":"insert","lines":["b"],"id":2009}],[{"start":{"row":157,"column":25},"end":{"row":157,"column":26},"action":"insert","lines":["y"],"id":2010}],[{"start":{"row":157,"column":26},"end":{"row":157,"column":27},"action":"insert","lines":[" "],"id":2011}],[{"start":{"row":157,"column":26},"end":{"row":157,"column":27},"action":"remove","lines":[" "],"id":2012}],[{"start":{"row":157,"column":27},"end":{"row":157,"column":28},"action":"insert","lines":[" "],"id":2013}],[{"start":{"row":157,"column":28},"end":{"row":157,"column":29},"action":"insert","lines":["f"],"id":2014}],[{"start":{"row":157,"column":29},"end":{"row":157,"column":30},"action":"insert","lines":["i"],"id":2015}],[{"start":{"row":157,"column":30},"end":{"row":157,"column":31},"action":"insert","lines":["r"],"id":2016}],[{"start":{"row":157,"column":31},"end":{"row":157,"column":32},"action":"insert","lines":["s"],"id":2017}],[{"start":{"row":157,"column":32},"end":{"row":157,"column":33},"action":"insert","lines":["t"],"id":2018}],[{"start":{"row":157,"column":33},"end":{"row":157,"column":34},"action":"insert","lines":["_"],"id":2019}],[{"start":{"row":157,"column":34},"end":{"row":157,"column":35},"action":"insert","lines":["d"],"id":2020}],[{"start":{"row":157,"column":35},"end":{"row":157,"column":36},"action":"insert","lines":["a"],"id":2021}],[{"start":{"row":157,"column":36},"end":{"row":157,"column":37},"action":"insert","lines":["y"],"id":2022}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"insert","lines":[":"],"id":2023}],[{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":[" "],"id":2024}],[{"start":{"row":158,"column":0},"end":{"row":159,"column":0},"action":"remove","lines":["      Person.find_by(name: 'Spartacus', rating: 4)",""],"id":2025}],[{"start":{"row":157,"column":51},"end":{"row":158,"column":0},"action":"insert","lines":["",""],"id":2026},{"start":{"row":158,"column":0},"end":{"row":158,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":158,"column":6},"end":{"row":158,"column":7},"action":"insert","lines":["b"],"id":2027}],[{"start":{"row":158,"column":7},"end":{"row":158,"column":8},"action":"insert","lines":["y"],"id":2028}],[{"start":{"row":158,"column":8},"end":{"row":158,"column":9},"action":"insert","lines":["e"],"id":2029}],[{"start":{"row":158,"column":9},"end":{"row":158,"column":10},"action":"insert","lines":["b"],"id":2030}],[{"start":{"row":158,"column":10},"end":{"row":158,"column":11},"action":"insert","lines":["u"],"id":2031}],[{"start":{"row":158,"column":11},"end":{"row":158,"column":12},"action":"insert","lines":["g"],"id":2032}],[{"start":{"row":35,"column":0},"end":{"row":36,"column":0},"action":"remove","lines":["    #byebug",""],"id":2033}],[{"start":{"row":35,"column":0},"end":{"row":36,"column":0},"action":"insert","lines":["",""],"id":2034}],[{"start":{"row":35,"column":0},"end":{"row":35,"column":2},"action":"insert","lines":["  "],"id":2035}],[{"start":{"row":35,"column":2},"end":{"row":35,"column":4},"action":"insert","lines":["  "],"id":2036}],[{"start":{"row":35,"column":4},"end":{"row":35,"column":5},"action":"insert","lines":["s"],"id":2037}],[{"start":{"row":35,"column":5},"end":{"row":35,"column":6},"action":"insert","lines":["e"],"id":2038}],[{"start":{"row":35,"column":6},"end":{"row":35,"column":7},"action":"insert","lines":["t"],"id":2039}],[{"start":{"row":35,"column":7},"end":{"row":35,"column":8},"action":"insert","lines":[" "],"id":2040}],[{"start":{"row":35,"column":7},"end":{"row":35,"column":8},"action":"remove","lines":[" "],"id":2041}],[{"start":{"row":35,"column":7},"end":{"row":35,"column":8},"action":"insert","lines":["_"],"id":2042}],[{"start":{"row":35,"column":8},"end":{"row":35,"column":9},"action":"insert","lines":["w"],"id":2043}],[{"start":{"row":35,"column":9},"end":{"row":35,"column":10},"action":"insert","lines":["e"],"id":2044}],[{"start":{"row":35,"column":10},"end":{"row":35,"column":11},"action":"insert","lines":["e"],"id":2045}],[{"start":{"row":35,"column":11},"end":{"row":35,"column":12},"action":"insert","lines":["k"],"id":2046}],[{"start":{"row":171,"column":89},"end":{"row":171,"column":90},"action":"insert","lines":[","],"id":2047}],[{"start":{"row":171,"column":90},"end":{"row":172,"column":0},"action":"insert","lines":["",""],"id":2048},{"start":{"row":172,"column":0},"end":{"row":172,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":172,"column":6},"end":{"row":173,"column":0},"action":"insert","lines":["        recipe_nutrients_attributes: [:id,:recipe_id,:nutrient_id,:valor], recipe_procedures_attributes: [:id, :recipe_id,:procedure_number, :title, :procedure, :_destroy])",""],"id":2049}],[{"start":{"row":171,"column":89},"end":{"row":171,"column":90},"action":"remove","lines":[","],"id":2050}],[{"start":{"row":171,"column":88},"end":{"row":171,"column":89},"action":"remove","lines":[")"],"id":2051}],[{"start":{"row":171,"column":88},"end":{"row":171,"column":89},"action":"insert","lines":[","],"id":2052}],[{"start":{"row":172,"column":79},"end":{"row":172,"column":177},"action":"remove","lines":[", recipe_procedures_attributes: [:id, :recipe_id,:procedure_number, :title, :procedure, :_destroy]"],"id":2053}],[{"start":{"row":172,"column":19},"end":{"row":172,"column":20},"action":"remove","lines":["e"],"id":2054}],[{"start":{"row":172,"column":18},"end":{"row":172,"column":19},"action":"remove","lines":["p"],"id":2055}],[{"start":{"row":172,"column":17},"end":{"row":172,"column":18},"action":"remove","lines":["i"],"id":2056}],[{"start":{"row":172,"column":16},"end":{"row":172,"column":17},"action":"remove","lines":["c"],"id":2057}],[{"start":{"row":172,"column":15},"end":{"row":172,"column":16},"action":"remove","lines":["e"],"id":2058}],[{"start":{"row":172,"column":14},"end":{"row":172,"column":15},"action":"remove","lines":["r"],"id":2059}],[{"start":{"row":172,"column":14},"end":{"row":172,"column":15},"action":"insert","lines":["w"],"id":2060}],[{"start":{"row":172,"column":15},"end":{"row":172,"column":16},"action":"insert","lines":["e"],"id":2061}],[{"start":{"row":172,"column":16},"end":{"row":172,"column":17},"action":"insert","lines":["e"],"id":2062}],[{"start":{"row":172,"column":17},"end":{"row":172,"column":18},"action":"insert","lines":["k"],"id":2063}],[{"start":{"row":153,"column":36},"end":{"row":154,"column":0},"action":"insert","lines":["",""],"id":2064},{"start":{"row":154,"column":0},"end":{"row":154,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":154,"column":6},"end":{"row":154,"column":7},"action":"insert","lines":["b"],"id":2065}],[{"start":{"row":154,"column":7},"end":{"row":154,"column":8},"action":"insert","lines":["y"],"id":2066}],[{"start":{"row":154,"column":8},"end":{"row":154,"column":9},"action":"insert","lines":["e"],"id":2067}],[{"start":{"row":154,"column":9},"end":{"row":154,"column":10},"action":"insert","lines":["b"],"id":2068}],[{"start":{"row":154,"column":10},"end":{"row":154,"column":11},"action":"insert","lines":["u"],"id":2069}],[{"start":{"row":154,"column":11},"end":{"row":154,"column":12},"action":"insert","lines":["g"],"id":2070}]]},"ace":{"folds":[],"scrolltop":439,"scrollleft":0,"selection":{"start":{"row":154,"column":12},"end":{"row":154,"column":12},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":30,"state":"start","mode":"ace/mode/ruby"}},"timestamp":1443698022460}